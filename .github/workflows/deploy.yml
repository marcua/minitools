name: Deploy to Server

on:
  push:
    branches:
      - main
      - '**'
  delete:
    branches:
      - '**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Don't run on delete events for main branch
    if: github.event_name != 'delete' || github.event.ref != 'main'

    steps:
      - name: Checkout repository
        if: github.event_name != 'delete'
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          # Configure SSH to use this key for the host
          cat >> ~/.ssh/config << EOF
          Host ${{ secrets.SSH_HOST }}
            IdentityFile ~/.ssh/deploy_key
            User ${{ secrets.SSH_USER }}
          EOF
          chmod 600 ~/.ssh/config

      - name: Determine deployment path
        id: deploy-path
        run: |
          if [ "${{ github.event_name }}" = "delete" ]; then
            # Branch deletion event
            BRANCH_NAME="${{ github.event.ref }}"
            SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
            echo "action=delete" >> $GITHUB_OUTPUT
            echo "path=${{ secrets.DEPLOY_BASE_PATH }}/_staging/${SANITIZED_BRANCH}" >> $GITHUB_OUTPUT
            echo "staging_name=${SANITIZED_BRANCH}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Main branch - deploy to root
            echo "action=deploy" >> $GITHUB_OUTPUT
            echo "path=${{ secrets.DEPLOY_BASE_PATH }}" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Other branches - deploy to staging
            BRANCH_NAME="${{ github.ref_name }}"
            SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
            echo "action=deploy" >> $GITHUB_OUTPUT
            echo "path=${{ secrets.DEPLOY_BASE_PATH }}/_staging/${SANITIZED_BRANCH}" >> $GITHUB_OUTPUT
            echo "staging_name=${SANITIZED_BRANCH}" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete staging directory (branch deletion)
        if: steps.deploy-path.outputs.action == 'delete'
        run: |
          ssh ${{ secrets.SSH_HOST }} "rm -rf '${{ steps.deploy-path.outputs.path }}'"

          echo "## ðŸ—‘ï¸ Staging Directory Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branch \`${{ github.event.ref }}\` was deleted." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Staging directory \`${{ steps.deploy-path.outputs.staging_name }}\` has been removed from the server." >> $GITHUB_STEP_SUMMARY

      - name: Rsync to server
        if: steps.deploy-path.outputs.action == 'deploy'
        run: |
          ssh ${{ secrets.SSH_HOST }} "mkdir -p '${{ steps.deploy-path.outputs.path }}'"

          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            ./ \
            ${{ secrets.SSH_HOST }}:${{ steps.deploy-path.outputs.path }}/

      - name: Print deployment info
        if: steps.deploy-path.outputs.action == 'deploy'
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deploy-path.outputs.is_main }}" = "true" ]; then
            echo "**Production** deployment from \`main\` branch." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View at: https://marcua.net/minitools" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Staging** deployment from \`${{ github.ref_name }}\` branch." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View at: https://marcua.net/minitools/_staging/${{ steps.deploy-path.outputs.staging_name }}" >> $GITHUB_STEP_SUMMARY
          fi
